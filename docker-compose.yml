# ============================================================================
# ServiceNow-Kafka Bridge â€” Docker Compose
#
# Services:
#   - kafka: Kraft-mode Kafka broker (no ZooKeeper dependency)
#   - bridge: The ServiceNow-Kafka Bridge application
#
# Usage:
#   docker compose up --build
#
# The bridge connects to Kafka and begins polling ServiceNow tables.
# Verify health at http://localhost:8080/healthz
# View Prometheus metrics at http://localhost:8080/metrics
# ============================================================================

services:
  kafka:
    image: apache/kafka:3.7.0
    container_name: kafka
    ports:
      - "9092:9092"
    environment:
      - KAFKA_NODE_ID=1
      - KAFKA_PROCESS_ROLES=broker,controller
      - KAFKA_LISTENERS=PLAINTEXT://:9092,CONTROLLER://:9093
      - KAFKA_ADVERTISED_LISTENERS=PLAINTEXT://kafka:9092
      - KAFKA_CONTROLLER_LISTENER_NAMES=CONTROLLER
      - KAFKA_LISTENER_SECURITY_PROTOCOL_MAP=CONTROLLER:PLAINTEXT,PLAINTEXT:PLAINTEXT
      - KAFKA_CONTROLLER_QUORUM_VOTERS=1@kafka:9093
      - KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR=1
      - KAFKA_TRANSACTION_STATE_LOG_REPLICATION_FACTOR=1
      - KAFKA_TRANSACTION_STATE_LOG_MIN_ISR=1
      - KAFKA_GROUP_INITIAL_REBALANCE_DELAY_MS=0
      - KAFKA_NUM_PARTITIONS=1
      # Auto-create topics for the bridge
      - KAFKA_AUTO_CREATE_TOPICS_ENABLE=true
      # Offset compaction for bridge offsets topic
      - KAFKA_LOG_CLEANUP_POLICY=delete
      - KAFKA_LOG_RETENTION_HOURS=168
    healthcheck:
      test: ["CMD-SHELL", "/usr/bin/kafka-broker-api-versions --bootstrap-server localhost:9092"]
      interval: 10s
      timeout: 5s
      retries: 10
    volumes:
      - kafka_data:/var/lib/kafka/data

  bridge:
    build:
      context: .
      args:
        VERSION: "0.1.0"
        COMMIT: "local"
        BUILD_DATE: "${BUILD_DATE:-unknown}"
    container_name: servicenow-kafka-bridge
    ports:
      - "8080:8080"
    depends_on:
      kafka:
        condition: service_healthy
    environment:
      # Override config values via environment variables
      - SN_BASE_URL=${SN_BASE_URL:-https://instance.service-now.com}
      - SN_OAUTH_CLIENT_ID=${SN_OAUTH_CLIENT_ID:-}
      - SN_OAUTH_CLIENT_SECRET=${SN_OAUTH_CLIENT_SECRET:-}
      - SN_OAUTH_USERNAME=${SN_OAUTH_USERNAME:-}
      - SN_OAUTH_PASSWORD=${SN_OAUTH_PASSWORD:-}
    volumes:
      - ./config.yaml:/app/config.yaml:ro
      - bridge_data:/app/data
    restart: unless-stopped

volumes:
  kafka_data:
  bridge_data:
